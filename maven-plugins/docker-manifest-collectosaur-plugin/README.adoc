= Docker-Manifest-Collectosaur-Plugin

== Quick Start ==

This example shows how to build a manifest of a reactor project with `Babyosaur` and `Mamaosaur`.

In this quick start, you will:

** Use `Babyosaur` to create a manifest for a single module.
** Use `Mamasaur` to aggregate all the manifest files from the child modules.

The **Maven** project is set up with a parent POM ([`pom.xml`](pom.xml)), and the module POMs ([`module-1/pom.xml`](module-1/pom.xml) and [`module-2/pom.xml`](module-2/pom.xml)) defines the build configuration specific to that module.

----
project-foo
  +- pom.xml (This is your parent pom.)
  +- module-1
  |    +- pom.xml (This is your module pom for the module-1 etc.)
  |    +- ...
  +- module-2
  |    +- pom.xml
  |    +- ...
  +- extra1.json
  +- ...
  +- target
  |    +- connect-manifest.json
----

=== Setup ===

`Babysaur` is declared inside child module POMs' build. You can define:

 ** baseImageName
 ** fullImageName
 ** serviceName

[source,xml]
----
<plugin>
    <groupId>cd.connect.pipeline</groupId>
    <artifactId>docker-manifest-collectosaur-plugin</artifactId>
    <version>@project.version@</version>
    <executions>
        <execution>
            <id>babysaur</id>
            <phase>package</phase>
            <goals>
                <goal>babysaur</goal>
            </goals>
            <configuration>
                <baseImageName>[Docker Image Name]</baseImageName>
            </configuration>
        </execution>
    </executions>
</plugin>
----

A `Mamaosaur` plugin declaration is defined in the parent POM's build:

[source,xml]
----
<plugin>
    <groupId>cd.connect.pipeline</groupId>
    <artifactId>docker-manifest-collectosaur-plugin</artifactId>
    <version>@project.version@</version>
    <executions>
        <execution>
            <id>mamasaur</id>
            <phase>package</phase>
            <goals>
                <goal>mamasaur</goal>
            </goals>
            <configuration>
                <additionalManifests>
                    <additionalManifest>extra1.json</additionalManifest>
                    <additionalManifest>extra2.json</additionalManifest>
                </additionalManifests>
            </configuration>
        </execution>
    </executions>
</plugin>
----

=== Build the project ===

[source,sh]
----
mvn package
----

When Maven **package** phase is executed, Maven first builds all of the submodule POMs, Maven then locates all of the submodule manifest files and copies all of these meta into a file named **connect-manifest.json** under the build folder.

An example of **connect-manifest.json** looks like this:

[source,yaml]
----
service1:
  image:
    prefix: 'blah/service1'
    tag: '1.0'
service2:
  image:
    prefix: 'blah/service2'
    tag: '1.0'
----

== Goal: Diffosaur
`Diffosaur` is a tool that helps you to build a set of modules. Say for example, you want to build only changed module.
This goal will output three files - diffosaur.txt|sh|bat, that contains names of changed module. Then this file can then be used to pass to Maven so it will only build the modules that specified (using flag `-pl`).

See *extended configuration* section below for a comprehensive list of configuration options.

To use this plugin declare the plugin:

[source,xml]
----
<execution>
    <id>diffosaur</id>
    <phase>initialize</phase>
    <goals>
        <goal>diffosaur</goal>
    </goals>
</execution>
----

== Goal:Deployosaur

This goal merges current build data with manifest of previous deployments if we are not on a special branch, known as the 'golden branch' - which usually is "master".

This goal is designed to take the input of the build and:

* output a yaml manifest file for `helm` for this deployment container
* output a docker manifest JSON file that can be attached as metadata for the next phase (a) if this container works
* If `buildNumber` and `deployContainerTagOutputFile` are defined, output a file which we write the tag name that was used.
This allows us to pass it onto the Retagosaur.
* write system properties: [$collectorsaurmanifest, $collectorsaurBranch, $collectorsaurSha, $collectorsaurTimestamp]

See *extended configuration* section below for a comprehensive list of configuration options.

To use this plugin declare the plugin:
[source,xml]
----
<execution>
    <id>collect</id>
    <phase>compile</phase>
    <goals>
        <goal>deployasaur</goal>
    </goals>
    <configuration>
        <dockerRegistry>gcr.io</dockerRegistry>
        <deployContainerImageName>featurehub/test-container</deployContainerImageName>
        <dockerRegistryBearerToken>@../../../docker-bearer-token.txt</dockerRegistryBearerToken>
        <targetEnvironment>ci</targetEnvironment>
        <inputManifestFile>target/connect-manifest.json</inputManifestFile>
        <outputYamlManifestFile>src/main/resources/manifest.yaml</outputYamlManifestFile>
        <outputJsonManifestFile>src/main/resources/manifest.json</outputJsonManifestFile>
        <pullRequest>My PR</pullRequest>
        <sha>12345</sha>
        <branch>monsters</branch>
    </configuration>
</execution>
----

=== Docker Tag Format

Docker tag value is generated using following format:
`timestamp.build.project-env.cluster.deploy.timestamp`

For example, our build tags for the deploy container look like this:

`1540501501119.7`

when they succeed they look like this:

`1540501501119.7.ci.nonprod.deploy.1540502359372.final.mergeSha`

(where `mergeSha` is the sha returned from the repository when something is merged.

`1540501501119.7.ci.nonprod.deploy.1540502359372`

(where the mergeSha is not provided, this is the tag of the promotable deployment image)

== Goal:Retagosaur
This goal will retag an existing tag, copying the manifest over. It is used once all of the e2e tests pass
and we are ready for an environment to be tagged.

It can be used one of two ways

.. using a mergeSha, which will add a new manifest with that sha so
it can be found by display tools (like the Connect Dashboard) to track back exactly where in the history it was
merged/squashed/rebased.
.. without a merge sha, which will cause it to create a .deploy.TIMESTAMP manifest which is intended for
the e2e run to indicate this is a "golden image".

[source, xml]
----
<execution>
    <id>retagosaur</id>
    <phase>package</phase>
    <goals>
        <goal>retagosaur</goal>
    </goals>
    <configuration>
        <dockerRegistry>${dockerRegistry}</dockerRegistry>
        <deployContainerImageName>${projectId}/${deployContainerImageName}</deployContainerImageName>
        <deployContainerTag>@deployContainerTag</deployContainerTag>
        <dockerRegistryBearerToken>../docker-bearer-token.txt</dockerRegistryBearerToken>
        <targetCluster>${targetCluster}</targetCluster>
        <targetNamespace>${targetNamespace}</targetNamespace>
        <mergeSha>12345</mergeSha>
    </configuration>
</execution>
----

== Extended Configuration ==

The notation below shows the plugin configuration property name followed by the settings configuration property in parentheses.

=== Babysaur

* `baseImageName`
** The base image name

* `fullImageName`
** The full image name

* `serviceName`
** The service name

* `extras`
** Use this option to specify additional information; for example, you can write the same module under different names

=== Mamasaur

* `additionalManifests`
** You can add additional manifest entries to connect-manifest.json using this option.
This will copy all entries in the file(s) into the manifest file

An example of the additionalManifests JSON file looks like this:

[source,JSON]
----
[
	{
		"baseImageName": "module-golang-1",
		"fullImageName": "blah/golang-1-2:2.0",
		"serviceName": "golang-1"
	}
]
----

=== Diffosaur

* `diffAgainst`
** The branch to run `gitdiff` command against
Note: it does not stop the build when the `gitdiff` command fails.
** default: master

* `pomLocation` (diffosaur.pomLocation)
** Specifies location to the POM file inside the project. It will use 'pom.xml' if no value is given.

* `outputFilePrefix` (diffosaur.outputFilePrefix)
** Output file name
** default: "diffosaur"

* `codeDirectoryPrefix` (diffosaur.codeDirectoryPrefix)
** Specifies the path prefix to remove from the source path when extracting module name from the diff command output
** default: ""

* `gitdiff` (diffosaur.gitDiff)
** The actual diff command
** default: "git diff --name-only ..$diffAgainst"

=== Deployosaur

Configuration parameters:

* `inputManifestFile`
** Locate the `connect-manifest.json` file

* `outputYamlManifestFile`
** The yaml manifest file for `helm`

* `outputJsonManfiestFile`
** The docker manifest JSON file

* `dockerRegistry`
** The docker container registry (e.g. gcr.io/[PROJECT-ID])

* `dockerRegistryBearerToken`
** The bear token used for authenticate API request to secure Docker API endpoints

* `deployContainerImageName`
** Name of the container image. This is used for looking for the latest image tag. Do not specify tag or digest.

* `targetNamespace`
** The target Kubernetes namespace

* `targetCluster`
** The target Kubernetes cluster

* `pullRequest`
** Pull request information in Docker manifest

* `sha`
** Sha meta information in Docker manifest

* `branch`
** Name of the branch in Docker manifest

* `buildNumber`
** Combine with automatic generated collectosaurTimestamp to generate the docker image tag

* `goldenBranch`
** A special branch that ignores previous builds

* `deployContainerTagOutputFile`
** A file that contains container tag output to make it available for sharing with the `Retagosaur`

=== Retagosaur

* `dockerRegistry`
** The docker container registry (e.g. gcr.io/[PROJECT-ID])

* `dockerRegistryBearerToken`
** The bear token used for authenticate API request to secure Docker API endpoints

* `deployContainerImageName`
** The image name that is going to be re-tagged

* `deployContainerTag`
** The deploy container tag name, or a path to a file if it starts with `@`

* `targetNamespace`
** The target Kubernetes namespace

* `targetCluster`
** The target Kubernetes cluster

* `mergeSha`
** The merge sha, which will add a new manifest with that sha so it can be found by display tools (like the Connect Dashboard) to track back exactly where in the history it was merged/squashed/rebased.

== License ==

https://opensource.org/licenses/Apache-2.0[Apache License 2.0]

== Community ==

The main documentation for link:http://connect.cd[Connect] can be found at: link:http://docs.connect.cd[docs.connect.cd]

'''
image::http://website.clearpoint.co.nz/connect/connect-logo-on-white-border.png[]
link:http://connect.cd[Connect] is a Continuous Delivery Platform that gathers best practice approaches for deploying working software into the cloud with confidence.

The main documentation for link:http://connect.cd[Connect] can be found at link:http://docs.connect.cd[docs.connect.cd]

Any queries on the link:http://connect.cd[Connect] platform can be sent to: connect@clearpoint.co.nz